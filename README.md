Приветствую, вот выполненое задание. Все описал в одной функцией, хотя хотелось разбить на несколько. Протестировал. Функция находится в index.php - как и было в исходнике.
Оставил вывод с тестовым массивом в index.